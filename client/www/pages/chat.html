<style type="text/css">
    .header {
        position: fixed;
        height: 64px;
        width: 100%;
        top: 0;
    }
    .footer {
        position: fixed;
        height: 64px;
        line-height: 64px;
        width: 100%;
        background: #FAFAFA;
        border-top: 1px solid #DDDDDD;
        bottom: 0;
    }
    .content {
        position: absolute;
        width: 100%;
        background: transparent;
    }
</style>

<script type="text/javascript">
    /* Основная страница с чатом */
    var page = {
        TIMER_WORK_INTERVAL: 5000, // Период работы основного таймера
        isStoped: false,
        privateUnread: 0,
        publicSended: false,
        privateSended: false,
        init: function () {
            chatService.lastPublicStamp = 0;
            chatService.lastPrivateStamp = 0;

            if (chatService.userDescription === undefined)
                chatService.getSelfInfo();

            page.toggleGroup = newToggleGroup()
                .addButton({
                    text: "Общий",
                    onTap: function () {
                        page.sendPanel.clearUser();
                        page.contentSlider.selectContent(0);
                    }
                })
                .addButton({
                    text: "Приват",
                    onTap: function () {
                        page.sendPanel.clearUser();
                        page.contentSlider.selectContent(1);
                        page.privateUnread = 0;
                        page.toggleGroup.clearSticker(1);
                    }
                });

            newToolbar('toolbar')
                .addButton({
                    position: "left",
                    type: "icon",
                    icon: "menu",
                    onTap: function () {
                        page.sidePanel.setUserInfo(chatService.userDescription);
                        page.sidePanel.show();
                    }
                })
                .addButton({
                    position: "right",
                    type: "icon",
                    "icon": "exit",
                    onTap: function () {
                        page.stop();
                        chatService.logout(function () {
                            pageManager.clear();
                            pageManager.loadPage('login');
                        });
                    }
                })
                .setTitle({
                    type: "control",
                    control: page.toggleGroup
                });

            page.contentSlider = newContentSlider('content-slider');
            page.publicChatList = newChatlist();
            page.publicChatList.onMessageTap = function(login) {
                global.recepient = login;
                page.sendPanel.clearTime();
                page.sendPanel.setUser(global.recepient);
            };
            page.publicChatList.onTimeTap = function(time) {
                global.messageTime = time;
                page.sendPanel.setTime(global.messageTime);
            };
            
            page.privateChatList = newChatlist();
            page.privateChatList.onMessageTap = function(login) {
                global.recepient = login;
                page.sendPanel.clearTime();
                page.sendPanel.setUser(global.recepient);
            };
            page.privateChatList.onTimeTap = function(time) {
                global.messageTime = time;
                page.sendPanel.setTime(global.messageTime);
            };
            
            page.contentSlider.addControl(page.publicChatList);
            page.contentSlider.addControl(page.privateChatList);
            page.contentSlider.onChange = function (ind) {
                page.toggleGroup.select(ind);
                page.sendPanel.clearUser();
                if (ind === 1) {
                    page.privateUnread = 0;
                    page.toggleGroup.clearSticker(1);
                }
            };

            page.sendPanel = newSendPanel('send-panel');
            page.sendPanel.onSend = function (text) {
                if (text === "") return;
                if (global.messageTime !== "") {
                    text = '{0}, {1}'.format(global.messageTime, text);
                }
                chatService.sendMessage(page.toggleGroup.selectedIndex, text, global.recepient, function (res) {
                    //console.log(res);
                });
            };
            page.sendPanel.onClearUser = function () {
                global.recepient = "";
            };
            page.sendPanel.onClearTime = function () {
                global.messageTime = "";
            };

            page.sidePanel = newSidePanel('overlay').setUserInfo({});
            page.sidePanel.onUserInfoTap = function (item) {
                pageManager.loadPage('user-info', item);
            };

            page.sidePanel.onUserSelect = function (login) {
                global.recepient = login;
                page.sendPanel.setUser(global.recepient);
            };

            chatService.onError = function (err) {
                // TODO Сделать обработку ошибок                
            };

            this.resize();
            this.startDataTimer(); // Запускает основной таймер, который запрашивает все данные
        },
        resize: function () {
            // TODO: убрать магию
            var height = $(window).height() - 128;
            var cont = $(".content");
            cont.css("height", height + "px");
            cont.css("top", "64px");
            page.sidePanel.resize();
            page.contentSlider.resize();
        },
        setTitleDate: function () {
            var str = moment().format("LL", "ru");
            page.publicChatList.setTitle(str);
            page.privateChatList.setTitle(str);
        },
        fixSmiles: function (mess) {
            var expr = /\(\(\d+\)\)/g;
            for (var i = 0; i < mess.length; i++) {
                var str = mess[i].message;
                while (true) {
                    var r = String(expr.exec(str));
                    if ((r === undefined) || (r === null) || (r === "null") || (r === "")) break;
                    var num = r.substring(2, r.length - 2);
                    str = str.replace(r, '<img src="{0}/chat/i/{1}.gif" />'.format(global.chatRoot, num));
                }
                mess[i].message = str;
            }
            return mess;
        },
        timerWork: function () {
            page.setTitleDate();

            chatService.getUserList(function (res) {
                page.sidePanel.setUsers(res);
            });

            // Если не было уже такого запроса, то запрашивает сообщения общей комнаты
            if (page.publicSended === false) {
                page.publicSended = true;
                page.publicChatList.showLoadIndicator();
                chatService.getPublicMessages(function (res) {
                    page.publicChatList.hideLoadIndicator();
                    var mess = page.fixSmiles(res.reverse());
                    page.publicChatList.addItems(mess);
                    page.publicChatList.clearLast();
                    page.publicSended = false;
                }, function (err) {
                    page.publicChatList.hideLoadIndicator();
                    if (err === chatService.ERR_MESSAGES_EMPTY) {
                        page.publicSended = false;
                    } else {
                        chatService.onError(err);
                    }
                });
            }

            // Если не было уже такого запроса, то запрашивает сообщения приватной комнаты
            if (!page.privateSended) {
                page.privateSended = true;
                page.privateChatList.showLoadIndicator();
                chatService.getPrivateMessages(function (res) {
                    page.privateChatList.hideLoadIndicator();
                    var mess =  page.fixSmiles(res.reverse());
                    if (page.toggleGroup.selectedIndex !== 1) {
                        page.privateUnread += mess.length;
                        page.toggleGroup.setSticker({
                            index: 1,
                            text: page.privateUnread < 33 ? page.privateUnread : '33+'
                        });
                    } else {
                        page.privateUnread = 0;
                        page.toggleGroup.clearSticker(1);
                    }

                    page.privateChatList.addItems(mess);
                    page.privateChatList.clearLast();
                    page.privateSended = false;
                }, function (err) {
                     page.privateChatList.hideLoadIndicator();
                    if (err === chatService.ERR_MESSAGES_EMPTY) {
                        page.privateSended = false;
                    } else {
                        chatService.onError(err);
                    }
                });
            }
        },
        startDataTimer: function () {
            page.timerWork();
            page.timer = setInterval(function () {
                if (!page.isStoped) {
                    page.timerWork();
                }
            }, page.TIMER_WORK_INTERVAL);
        },
        saveState: function () {

        },
        loadState: function () {

        },
        // Вызывается при остановки деятельности страницы
        stop: function () {
            page.isStoped = true;
            clearInterval(page.timer);
            chatService.abortAll();
        }
    };
    window['page'] = page;
</script>

<div class="header">
    <div id="toolbar" class="mtoolbar">
    </div>
</div>

<div id="content-slider" class="content">
    <!--    <div id="chat-list">
        </div> -->
</div>

<div class="footer">
    <div id="send-panel" class="msendpanel">
    </div>
    <div id="room-tabs">
    </div>
</div>

<div id="overlay">
</div>