<style type="text/css">
    .header {
        position: fixed;
        height: 64px;
        width: 100%;
        top: 0;
    }
    .footer {
        position: fixed;
        height: 64px;
        line-height: 64px;
        width: 100%;
        background: #FAFAFA;
        border-top: 1px solid #DDDDDD;
        bottom: 0;
    }
    .content {
        position: absolute;
        width: 100%;
        background: transparent;
        z-index: 9998;
    }

</style>

<script type="text/javascript">
    var page = {
        isStoped: false,
        privateUnread: 0,
        init: function () {
            chatService.lastPublicStamp = 0;
            chatService.lastPrivateStamp = 0;

            page.toggleGroup = newToggleGroup()
                    .addButton({
                        text: "Общий",
                        onTap: function () {
                            page.contentSlider.selectContent(0);
                        }
                    })
                    .addButton({
                        text: "Приват",
                        onTap: function () {
                            page.contentSlider.selectContent(1);
                            page.privateUnread = 0;
                            page.toggleGroup.clearSticker(1);                            
                        }
                    });

            newToolbar('toolbar')
                    .addButton({
                        position: "left",
                        type: "icon",
                        icon: "menu",
                        onTap: function () {
                            page.sidePanel.show();
                        }
                    })
                    .addButton({
                        position: "right",
                        type: "icon",
                        "icon": "exit",
                        onTap: function () {
                            // TODO: confirm dialog, logout

                            pageManager.clear();
                            pageManager.loadPage('login');
                        }
                    })
                    .setTitle({
                        type: "control",
                        control: page.toggleGroup
                    });

            page.contentSlider = newContentSlider('content-slider');
            page.publicChatList = newChatlist();
            page.privateChatList = newChatlist();
            page.contentSlider.addControl(page.publicChatList);
            page.contentSlider.addControl(page.privateChatList);
            page.contentSlider.onChange = function (ind) {
                page.toggleGroup.select(ind);
            };

            page.sendPanel = newSendPanel('send-panel');

            page.sidePanel = newSidePanel('overlay').setUserInfo({});
            page.sidePanel.onUserInfoTap = function (item) {
                pageManager.loadPage('user-info', item);
            };

            chatService.onError = function (err) {
                if (!page.isStoped) {

                }
            };

            this.resize();
            this.startDataTimer();
        },
        resize: function () {
            // TODO: remove magic
            var height = $(window).height() - 128;
            var cont = $(".content");
            cont.css("height", height + "px");
            cont.css("top", "64px");
            page.sidePanel.resize();
            page.contentSlider.resize();
        },
        timerWork: function () {
            chatService.getUserList(function (res) {
                page.sidePanel.setUsers(res);
            });

            chatService.getPublicMessages(function (res) {
                var mess = res.reverse();
                //console.log(mess);
                page.publicChatList.addItems(mess);
                page.publicChatList.clearLast();
            });

            chatService.getPrivateMessages(function (res) {
                var mess = res.reverse();
                // console.log(mess);

                if (page.toggleGroup.selectedIndex !== 1) {
                    page.privateUnread += mess.length;                    
                    page.toggleGroup.setSticker({
                        index: 1,
                        text: page.privateUnread < 33 ? page.privateUnread : '33+'
                    });
                } else {
                    page.privateUnread = 0;
                    page.toggleGroup.clearSticker(1);
                }

                page.privateChatList.addItems(mess);
                page.privateChatList.clearLast();
            });
        },
        startDataTimer: function () {
            page.timerWork();
            page.timer = setInterval(function () {
                if (!page.isStoped) {
                    page.timerWork();
                }
            }, 5000);
        },
        saveState: function () {

        },
        loadState: function () {

        },
        stop: function () {
            page.isStoped = true;
            clearInterval(page.timer);
        }
    }
</script>

<div class="header">
    <div id="toolbar" class="mtoolbar">
    </div>
</div>

<div id="content-slider" class="content">
    <!--    <div id="chat-list">
        </div> -->
</div>

<div class="footer">
    <div id="send-panel" class="msendpanel">
    </div>
    <div id="room-tabs">
    </div>
</div>

<div id="overlay">    
</div>